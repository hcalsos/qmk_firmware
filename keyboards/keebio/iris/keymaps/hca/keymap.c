#include QMK_KEYBOARD_H


#define _QWERTY 0
#define _LOWER 1
#define _RAISE 2
#define _ADJUST 3

#define LOCK LGUI(LCTL(KC_Q))
#define ALT_ENT RALT_T(KC_ENT)

enum custom_keycodes {
  QWERTY = SAFE_RANGE,
  LOWER,
  RAISE,
  ADJUST,
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

  //  ,---------+----+----+----+----+----.                ,----+----+----+----+----+---------.
  //  | ESC     | 1  | 2  | 3  | 4  | 5  |                | 6  | 7  | 8  | 9  | 0  |   BCSPC |
  //  |---------+----+----+----+----+----|                |----+----+----+----+----+---------|
  //  | TAB     | Q  | W  | E  | R  | T  |                | Y  | U  | I  | O  | P  |   /     |
  //  |---------+----+----+----+----+----|                |----+----+----+----+----+---------|
  //  | CTRL    | A  | S  | D  | F  | G  |                | H  | J  | K  | L  | ;  |   '     |
  //  |---------+----+----+----+----+----+------.    ,----|----+----+----+----+----+---------|
  //  | SFT/LPRN| Z  | X  | C  | V  | B  |  *   |    | *  | N  | M  | ,  | .  | /  | SFT/RPRN|
  //  `---------+----+----+--+-+----+----+------/    \----+----+----+----+----+----+---------'
  //                     \  LOWER|  GUI  | SPC /      \ SPC\ ALT/ENT |  RAISE  /
  //                      `------+-------+----'        `----+--------+--------'

  [_QWERTY] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     KC_ESC,  KC_1,    KC_2,    KC_3,    KC_4,    KC_5,                               KC_6,    KC_7,    KC_8,    KC_9,    KC_0,    KC_BSPC,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     KC_TAB,  KC_Q,    KC_W,    KC_E,    KC_R,    KC_T,                               KC_Y,    KC_U,    KC_I,    KC_O,    KC_P,    KC_BSLS,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     KC_LCTL, KC_A,    KC_S,    KC_D,    KC_F,    KC_G,                               KC_H,    KC_J,    KC_K,    KC_L,    KC_SCLN, KC_QUOT,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     KC_LSPO,   KC_Z,    KC_X,    KC_C,    KC_V,  KC_B,    KC_MPLY,           LOCK,    KC_N,    KC_M,    KC_COMM, KC_DOT, KC_SLSH,  KC_RSPC,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                     LOWER,  KC_LGUI,  KC_SPC,                    KC_SPC, ALT_ENT,  RAISE
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  //  ,----+----+----+----+----+----.              ,----+----+----+----+----+----.
  //  |  ~ |    |    |    |    |    |              |    | 7  | 8  | 9  | +  | DEL|
  //  |----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |    |    |    |    |    |    |              |    | 4  | 5  | 6  | -  |    |
  //  |----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |    |    |    |    |    | [  |              | ]  | 1  | 2  | 3  | *  |    |
  //  |----+----+----+----+----+----+----.    ,----|----+----+----+----+----+----|
  //  | \  |    |    |    |    | {  |    |    |    | }  | 0  | .  |    | /  | =  |
  //  `----+----+----+--+-+----+----+----/    \----+----+----+----+----+----+----'
  //                 \     |      | DEL /      \ DEL\       |     /
  //                  `----+------+----'        `----+------+----'


  [_LOWER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     KC_TILD, _______, _______, _______, _______, _______,                            _______, KC_P7,    KC_P8,   KC_P9,  KC_PLUS, KC_BSPC,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______,  KC_P4,   KC_P5,   KC_P6,  KC_MINS, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, KC_LBRC,                            KC_RBRC,  KC_P1,   KC_P2,   KC_P3,  KC_PAST, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, KC_LCBR, _______,          _______, KC_RCBR,  KC_P0,  KC_PDOT, _______, KC_PSLS,  KC_EQL,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, KC_DEL,                    KC_DEL,  _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  //  ,----+----+----+----+----+----.              ,----+----+----+----+----+----.
  //  |F12 | F1 | F2 | F3 | F4 | F5 |              | F6 | F7 | F8 | F9 |F10 |F11 |
  //  |----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |TOG |PGUP| UP |PGDN|    |    |              |    |    |    |    |    |    |
  //  |----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |    |LEFT|DOWN|RGHT|    |    |              |    |    |    |    |    |HOME|
  //  |----+----+----+----+----+----+----.    ,----|----+----+----+----+----+----|
  //  |    |    |    |    |    |    |  * |    | *  |    |    |    |    |    |END |
  //  `----+----+----+--+-+----+----+----/    \----+----+----+----+----+----+----'
  //                 \     |      | DEL /      \ DEL\       |     /
  //                  `----+------+----'        `----+------+----'


  [_RAISE] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     KC_F12,  KC_F1,   KC_F2,   KC_F3,   KC_F4,   KC_F5,                               KC_F6,   KC_F7,   KC_F8,   KC_F9,   KC_F10,  KC_F11,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     RGB_TOG, KC_HOME,  KC_UP,  KC_END,  _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, KC_LEFT, KC_DOWN, KC_RIGHT, _______, _______,                           _______, _______, _______, _______, _______, KC_HOME,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     KC_LSFT, _______, _______, _______, _______, _______, _______,          _______, _______, _______, _______, _______, _______, KC_END,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),


  //  ,-----+----+----+----+----+----.              ,----+----+----+----+----+----.
  //  |RESET|    |    |    |    |    |              |    |    |    |    |    |    |
  //  |-----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |     |    |    |    |    |    |              |    |    |    |    |    |    |
  //  |-----+----+----+----+----+----|              |----+----+----+----+----+----|
  //  |     |    |    |    |    |    |              |    |    |    |    |    |    |
  //  |-----+----+----+----+----+----+----.    ,----|----+----+----+----+----+----|
  //  |     |    |    |    |    |    |    |    |    |    |    |    |    |    |    |
  //  `-----+----+----+--+-+----+----+----/    \----+----+----+----+----+----+----'
  //                 \     |      |     /       \    \       |     /
  //                  `----+------+----'         `----+------+----'


  [_ADJUST] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     RESET,   _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, _______, _______, _______, _______, _______, _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  )
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  switch (keycode) {
    case QWERTY:
      if (record->event.pressed) {
        set_single_persistent_default_layer(_QWERTY);
      }
      return false;
      break;
    case LOWER:
      if (record->event.pressed) {
        layer_on(_LOWER);
        update_tri_layer(_LOWER, _RAISE, _ADJUST);
      } else {
        layer_off(_LOWER);
        update_tri_layer(_LOWER, _RAISE, _ADJUST);
      }
      return false;
      break;
    case RAISE:
      if (record->event.pressed) {
        layer_on(_RAISE);
        update_tri_layer(_LOWER, _RAISE, _ADJUST);
      } else {
        layer_off(_RAISE);
        update_tri_layer(_LOWER, _RAISE, _ADJUST);
      }
      return false;
      break;
    case ADJUST:
      if (record->event.pressed) {
        layer_on(_ADJUST);
      } else {
        layer_off(_ADJUST);
      }
      return false;
      break;
  }
  return true;
}

void keyboard_post_init_user(void) {
	rgblight_enable_noeeprom();
	rgblight_mode_noeeprom(RGBLIGHT_MODE_STATIC_LIGHT);
	layer_state_set_user(layer_state);
};

// Turn on RGB underglow according to active layer
uint32_t layer_state_set_user(uint32_t state) {
	switch (biton32(state)) {
		case _ADJUST: rgblight_sethsv_noeeprom(0, 255, 200); break;
		case _LOWER: rgblight_sethsv_noeeprom(162, 255, 100); break;
		case _RAISE: rgblight_sethsv_noeeprom(90, 255, 100); break;
		default: rgblight_sethsv_noeeprom(13, 255, 100); break;
	}
	return state;
};

void encoder_update_user(uint8_t index, bool clockwise) {
    if (index == 0) {
	switch (biton32(layer_state)) {
          case _QWERTY:
	        if (clockwise) {
		        tap_code(KC_VOLU);
	        } else {
		        tap_code(KC_VOLD);
	        }
	        break;
          case _LOWER:
	        if (clockwise) {
                tap_code(KC_MNXT);
            } else {
                tap_code(KC_MPRV);
            }
            break;
        case _RAISE:
	    if (clockwise) {
                tap_code(KC_PGUP);
            } else {
                tap_code(KC_PGDN);
            }
            break;
        }
    }
    else if (index == 1) {
        if (clockwise) {
            tap_code16(LCTL(KC_RIGHT));
        } else {
            tap_code16(LCTL(KC_LEFT));
        }
    }
}
